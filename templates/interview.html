<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HR Interview Call</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
      :root {
        --primary: #1e40af;
        --primary-dark: #1e3a8a;
        --primary-light: #dbeafe;
        --secondary: #374151;
        --accent: #6b7280;
        --success: #059669;
        --danger: #dc2626;
        --danger-dark: #b91c1c;
        --light: #f8fafc;
        --dark: #111827;
        --gray: #6b7280;
        --light-gray: #e5e7eb;
        --white: #ffffff;
        --hr-bubble: linear-gradient(135deg, #1e40af 0%, #374151 100%);
        --user-bubble: linear-gradient(135deg, #374151 0%, #6b7280 100%);
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12),
          0 1px 2px rgba(0, 0, 0, 0.24);
        --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.15),
          0 4px 10px rgba(0, 0, 0, 0.1);
        --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.1),
          0 8px 16px rgba(0, 0, 0, 0.06);
        --border-radius: 12px;
        --border-radius-lg: 16px;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #f8fafc 0%, #e5e7eb 100%);
        overflow: hidden;
        color: var(--dark);
        line-height: 1.6;
      }
      .container {
        display: flex;
        height: 100vh;
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.95);
        border-radius: var(--border-radius-lg);
        margin: 0px;
        overflow: hidden;
        box-shadow: var(--shadow-xl);
        border: 1px solid rgba(229, 231, 235, 0.8);
      }
      /* Left panel - 25% width */
      .left-panel {
        width: 25%;
        height: 100%;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        display: flex;
        flex-direction: column;
        border-right: 1px solid rgba(229, 231, 235, 0.8);
        position: relative;
        border-radius: var(--border-radius-lg) 0 0 var(--border-radius-lg);
        gap: 10px;
      }
      .video-container {
        display: flex;
        flex-direction: column;
        padding: 15px;
        gap: 40px;
        height: 80%;
        padding-bottom: 5px;
      }
      .hr-image-container {
        position: relative;
        height: 100%;
        width: 100%;
        display: flex;
        padding: 15px;
        gap: 40;
        justify-content: center;
        align-items: center;
        background: linear-gradient(
          135deg,
          rgba(30, 64, 175, 0.05),
          rgba(55, 65, 81, 0.05)
        );
        border-radius: var(--border-radius);
        padding: 20px;
        border: 1px solid rgba(229, 231, 235, 0.5);
      }
      .user-video-container {
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        background: rgba(248, 250, 252, 0.8);
        border-radius: var(--border-radius);
        width: 100%;
        border: 1px solid rgba(229, 231, 235, 0.5);
      
      }
      .hr-image {
        width: 140px;
        height: 140px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid var(--white);
        box-shadow: var(--shadow-lg);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        z-index: 2;
      }
      .hr-image:hover {
        transform: scale(1.08);
        box-shadow: var(--shadow-xl);
      }
      .audio-animation {
        position: absolute;
        width: 140px;
        height: 140px;
        border-radius: 50%;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 1;
      }
      .audio-animation.active {
        opacity: 1;
        animation: pulse 2s infinite, rotate 8s linear infinite;
      }
      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(30, 64, 175, 0.6);
          transform: scale(1);
        }
        50% {
          box-shadow: 0 0 0 20px rgba(30, 64, 175, 0.1);
          transform: scale(1.05);
        }
        100% {
          box-shadow: 0 0 0 40px rgba(30, 64, 175, 0);
          transform: scale(1);
        }
      }
      @keyframes rotate {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      #user-cam {
        width: 100%;
        height: 100%;
        border-radius: 15px;
        box-shadow: var(--shadow-md);
        background: var(--light);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        object-fit: cover;
      }
      #user-cam:hover {
        transform: scale(1.02);
        box-shadow: var(--shadow-lg);
      }
      /* Right panel - 75% width - Chat interface */
      .right-panel {
        width: 75%;
        height: 100%;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        display: flex;
        flex-direction: column;
        position: relative;
        border-radius: 0 var(--border-radius-lg) var(--border-radius-lg) 0;
      }
      .header {
        display: flex;
        top: 0;
        position: fixed;
        align-items: center;
        justify-content: center;
        width: 100%;
      }
      .chat-header {
        padding: 20px 25px;
        background: linear-gradient(
          135deg,
          rgba(30, 64, 175, 0.05),
          rgba(55, 65, 81, 0.05)
        );
        border-bottom: 1px solid rgba(229, 231, 235, 0.8);
        text-align: center;
        border-radius: 0 var(--border-radius-lg) 0 0;
        width: 100%;
      }
      .chat-header h2 {
  margin-left: 25rem;
  color: var(--primary);
  font-size: 24px;
  font-weight: 700;
  display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #1e40af, #374151);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .chat-container {
        flex: 1;
        flex-direction: column;
        padding: 25px;
        overflow-y: auto;
        background: linear-gradient(
          135deg,
          rgba(248, 250, 252, 0.9),
          rgba(241, 245, 249, 0.9)
        );
        scroll-behavior: smooth;
        position: relative;
        height: auto;
      }
      .chat-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: radial-gradient(
            circle at 25% 25%,
            rgba(30, 64, 175, 0.03) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 75% 75%,
            rgba(55, 65, 81, 0.03) 0%,
            transparent 50%
          );
        pointer-events: none;
      }
      .message {
        margin-bottom: 20px;
        max-width: 75%;
        padding: 18px 24px;
        border-radius: var(--border-radius);
        line-height: 1.6;
        position: relative;
        font-size: 16px;
        box-shadow: var(--shadow-sm);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(229, 231, 235, 0.3);
      }
      .message::before {
        content: "";
        position: absolute;
        width: 0;
        height: 0;
        border-style: solid;
      }
      .message:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-lg);
      }
      .hr-message {
        background: var(--hr-bubble);
        color: var(--white);
        align-self: flex-start;
        border-bottom-left-radius: 8px;
        margin-right: auto;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }
      .hr-message::before {
        bottom: 0;
        left: -8px;
        border-width: 0 8px 8px 0;
        border-color: transparent #1e40af transparent transparent;
      }
      .user-message {
        background: var(--user-bubble);
        color: var(--white);
        align-self: flex-end;
        margin-left: auto;
        border-bottom-right-radius: 8px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }
      .user-message::before {
        bottom: 0;
        right: -8px;
        border-width: 0 0 8px 8px;
        border-color: transparent transparent #374151 transparent;
      }
      .message-header {
        font-weight: 700;
        margin-bottom: 8px;
        font-size: 13px;
        opacity: 0.9;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .input-container {
        padding: 25px;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        border-top: 1px solid rgba(229, 231, 235, 0.8);
        display: flex;
        gap: 15px;
        align-items: center;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
        border-radius: 0 0 var(--border-radius-lg) 0;
        position: sticky;
        bottom: 0px;
        overflow: hidden;
      }
      #user-input {
        flex: 1;
        padding: 16px 24px;
        font-size: 16px;
        border-radius: var(--border-radius-lg);
        border: 2px solid rgba(102, 126, 234, 0.2);
        outline: none;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        box-shadow: var(--shadow-sm);
      }
      #user-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(30, 64, 175, 0.15);
        background: var(--white);
      }
      button {
        padding: 16px 28px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        border-radius: var(--border-radius-lg);
        border: none;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: var(--white);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: var(--shadow-md);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: relative;
        overflow: hidden;
      }
      button::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }
      button:hover::before {
        left: 100%;
      }
      button:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }
      button:active {
        transform: translateY(0);
      }
      .voice-btn {
        background: linear-gradient(135deg, var(--success), #047857);
        padding: 16px;
        min-width: 56px;
        font-size: 20px;
      }
      .voice-btn:hover {
        background: linear-gradient(135deg, #047857, #065f46);
      }
      .unlock-btn {
        background: linear-gradient(135deg, var(--danger), var(--danger-dark));
        padding: 16px;
        min-width: 56px;
        font-size: 20px;
        margin-left: 8px;
      }
      .unlock-btn:hover {
        background: linear-gradient(135deg, var(--danger-dark), #991b1b);
      }
      .end-interview-btn {
        position: absolute;
        bottom: 35px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, var(--danger), var(--danger-dark));
        width: 80%;
        padding: 16px;
        font-size: 16px;
        font-weight: 700;
        overflow: hidden;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
      }
      .end-interview-btn:hover {
        transform: translateX(-50%) translateY(-2px);
        box-shadow: var(--shadow-xl);
        overflow: hidden;
      }
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: var(--white);
        animation: spin 1s ease-in-out infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          135deg,
          rgba(30, 64, 175, 0.9),
          rgba(55, 65, 81, 0.9)
        );
        backdrop-filter: blur(10px);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .loading-overlay.active {
        opacity: 1;
        pointer-events: all;
      }
      .loading-text {
        margin-top: 30px;
        font-size: 20px;
        font-weight: 600;
        color: var(--white);
        text-align: center;
        animation: fadeInOut 2s infinite;
      }
      @keyframes fadeInOut {
        0%,
        100% {
          opacity: 0.7;
        }
        50% {
          opacity: 1;
        }
      }
      /* Enhanced scrollbar styling */
      .chat-container::-webkit-scrollbar {
        width: 12px;
      }
      .chat-container::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
      }
      .chat-container::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border-radius: 10px;
        border: 2px solid rgba(229, 231, 235, 0.1);
      }
      .chat-container::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(
          135deg,
          var(--primary-dark),
          var(--secondary)
        );
      }
      /* Floating elements animation */
      .floating-elements {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        pointer-events: none;
        z-index: 0;
      }
      .floating-element {
        position: absolute;
        width: 4px;
        height: 4px;
        background: rgba(30, 64, 175, 0.2);
        border-radius: 50%;
        animation: float 20s infinite linear;
      }
      @keyframes float {
        0% {
          transform: translateY(100vh) rotate(0deg);
          opacity: 0;
        }
        10% {
          opacity: 1;
        }
        90% {
          opacity: 1;
        }
        100% {
          transform: translateY(-100px) rotate(360deg);
          opacity: 0;
        }
      }

      /* Add new styles for the menu button and hidden content */
      .menu-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--primary);
        display: none; /* Hidden by default on desktop */
      }
      .hidden-menu {
        display: none; /* hide by default */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #f9fafb;
        z-index: 999;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
      }
      .hidden-menu.active {
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        padding: 10px;
        gap: 20px;
      }
      /* HR image + user camera stacked vertically */
      .hidden-menu .video-stack {
        display: flex;
        flex-direction: column;
        gap: 15px;
        width: 100%;
        flex: 1;
        justify-content: center;
        align-items: center;
      }

      .top-left-content {
        display: flex;
        flex-direction: column;
        justify-content: center; /* Stacks children vertically by default */
        align-items: center;
        gap: 20px;
        width: 100%;

        position: relative; /* Needed for positioning the close button */
      }
      #close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: #ef4444;
        color: #fff;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        z-index: 1001; /* Ensures it is clickable */
      }
      .menu-content {
        display: flex;
        flex-direction: column;
        gap: 20px;
        width: 100%;
        height: 100%;
        justify-content: center;
        align-items: center;
        padding: 20px;
        background: var(--light);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-xl);
      }
      /* End Interview button inside the menu */
      .menu-content .end-interview-btn {
        position: static;
        transform: none;
        width: 100%;
        padding: 16px;
      }
      .menu-content .hr-image-container,
      .menu-content .user-video-container {
        width: 100%;
        height: auto;
        aspect-ratio: 16/9; /* Set aspect ratio for video-like appearance */
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--shadow-md);
      }
      .menu-content .hr-image,
      .menu-content #user-cam {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .menu-content .end-interview-btn {
        position: static;
        transform: none;
        width: 100%;
        padding: 16px;
        margin-top: auto; /* Pushes the button to the bottom */
      }
      .menu-content .end-interview-btn:hover {
        transform: translateY(-2px);
      }
      /* Each video block full width with aspect ratio */
      .hidden-menu .hr-image-container,
      .hidden-menu .user-video-container {
        width: 100%;
        max-width: 480px;
        aspect-ratio: 16/9;
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--shadow-md);
      }
      /* End Interview pinned to bottom */
      #end-interview-btn-mobile {
        margin-top: auto;
        width: 90%;
        max-width: 400px;

        bottom: 20px;
      }
      #interview-timer {
        margin-left: auto; /* Pushes timer to the right */
        font-size: 18px;
        font-weight: 600;
        color: var(--primary);
      }
      .chat-header {
        display: flex;
        align-items: center;
        gap: 15px;

        padding: 15px 25px;
        background: linear-gradient(
          135deg,
          rgba(30, 64, 175, 0.05),
          rgba(55, 65, 81, 0.05)
        );
        border-bottom: 1px solid rgba(229, 231, 235, 0.8);
      }

      /* --- */
      /* Responsive adjustments */
      /* --- */
      @media (max-width: 1200px) {
        .left-panel {
          width: 30%;
        }
        .right-panel {
          width: 70%;
        }
        .message {
          max-width: 85%;
        }
      }
      /* Tablet-specific */
      @media (max-width: 1024px) {
        .left-panel {
          width: 35%;
        }
        .right-panel {
          width: 65%;
        }
        .chat-header h2 {
          font-size: 20px;
        }
        .message {
          font-size: 15px;
        }
      }
      /* Mobile-specific */
      @media (max-width: 768px) {
        .container {
          flex-direction: column;
          margin: 5px;
          height: 98vh;
        }
        .left-panel {
          display: none;
        }
        .right-panel {
          width: 100%;
          border-radius: 0;
        }
        .chat-header {
          display: flex;
          align-items: center;
          gap: 15px;
          padding: 15px;
        }
        .chat-header h2 {
          flex: 1;
        }
        .menu-btn {
          display: block; /* Show the menu button */
        }
        /* Input area */
        .input-container {
          flex-direction: row;
          flex-wrap: wrap;
          justify-content: center;
          padding: 12px;
          gap: 10px;
        }
        #user-input {
          flex: 1 1 100%; /* The input field stays full width */
          padding: 12px 16px;
        }
        .input-container button {
          flex: 1 1 auto;
          min-width: 45%;
          padding: 12px;
        }
      }
      /* Accessibility improvements */
      @media (prefers-reduced-motion: reduce) {
        * {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }
      }
      /* High contrast mode */
      @media (prefers-contrast: high) {
        :root {
          --primary: #1e40af;
          --secondary: #374151;
          --danger: #dc2626;
          --success: #059669;
        }
      }
      @media (min-width: 480px) {
        .top-left-content {
          flex-direction: row;
          justify-content: center;
          align-items: flex-start;
        }
        .menu-content .hr-image-container,
        .menu-content .user-video-container {
          width: 45%;
          max-width: 200px; /* Prevents them from getting too big */
        }
      }
    </style>
  </head>
  <body>
    <div class="floating-elements">
      <div
        class="floating-element"
        style="left: 10%; animation-delay: 0s"
      ></div>
      <div
        class="floating-element"
        style="left: 20%; animation-delay: 2s"
      ></div>
      <div
        class="floating-element"
        style="left: 30%; animation-delay: 4s"
      ></div>
      <div
        class="floating-element"
        style="left: 40%; animation-delay: 6s"
      ></div>
      <div
        class="floating-element"
        style="left: 50%; animation-delay: 8s"
      ></div>
      <div
        class="floating-element"
        style="left: 60%; animation-delay: 10s"
      ></div>
      <div
        class="floating-element"
        style="left: 70%; animation-delay: 12s"
      ></div>
      <div
        class="floating-element"
        style="left: 80%; animation-delay: 14s"
      ></div>
      <div
        class="floating-element"
        style="left: 90%; animation-delay: 16s"
      ></div>
    </div>
    <div class="container">
      <div class="left-panel">
        <div class="video-container">
          <div class="hr-image-container">
            <img
              src="/static/interviewer.jpg"
              alt="Interviewer"
              class="hr-image"
            />
            <div class="audio-animation" id="audio-animation"></div>
          </div>
          <div class="user-video-container">
            <video id="user-cam" autoplay muted playsinline></video>
          </div>
        </div>
        <button class="end-interview-btn" id="end-interview-btn">
          <span id="end-interview-text">End Interview</span>
        </button>
      </div>

      <div class="right-panel">
        <div class="chat-header">
          <button class="menu-btn" onclick="toggleMenu()">â˜°</button>
          <h2>Interview Session</h2>
          <div id="interview-timer">
            <span id="timer-icon"
              ><i class="fa-regular fa-clock" style="margin-right: 5px"></i
            ></span>
            <span id="timer-text">00:00</span>
          </div>
        </div>
        <div class="chat-container" id="chat-container"></div>

        <div class="input-container">
          <input
            type="text"
            id="user-input"
            placeholder="Type or speak your answer..."
          />
          <button onclick="sendMessage()">Send</button>
          <button onclick="startVoice()" class="voice-btn">ðŸŽ¤</button>
          <button
            onclick="forceUnlock()"
            class="unlock-btn"
            id="unlock-btn"
            style="display: none"
            title="Click if you're stuck waiting"
          >
            ðŸ”“
          </button>
        </div>
      </div>

      <div class="hidden-menu" id="hidden-menu">
        <button id="close-btn">âœ–</button>

        <div class="video-stack">
          <div class="hr-image-container">
            <img
              src="/static/interviewer.jpg"
              alt="Interviewer"
              class="hr-image"
            />
            <div class="audio-animation" id="audio-animation"></div>
          </div>
          <div class="user-video-container">
            <video id="user-cam" autoplay muted playsinline></video>
          </div>
        </div>

        <button class="end-interview-btn" id="end-interview-btn-mobile">
          End Interview
        </button>
      </div>

      <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Generating your interview report...</div>
      </div>
    </div>

    <script>
      let recognition;
      let accumulatedTranscript = "";
      let isListening = false;
      let silenceTimer;
      let restartTimer;
      const SILENCE_TIMEOUT = 5000;
      const RESTART_INTERVAL = 45000;
      let isAIResponding = false;
      let isSpeaking = false;
      let speechUnlockTimer = null;
      let speechTimeoutTimer = null;

      let hasSpokenPrompt = false;

      window.onload = () => {
        console.log("Initialized Interview App");
        setTimeout(() => {
          addMessageToChat(
            "Interviewer",
            "Hello! Welcome to your interview. Let's begin by having you tell me about yourself.",
            "hr-message"
          );
        }, 500);

        document
          .getElementById("user-input")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") sendMessage();
          });
        const endBtnMobile = document.getElementById(
          "end-interview-btn-mobile"
        );
        if (endBtnMobile) endBtnMobile.addEventListener("click", endInterview);
        document
          .getElementById("user-input")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") sendMessage();
          });

        document
          .getElementById("end-interview-btn")
          .addEventListener("click", endInterview);

        initializeWebcam();
      };

      function initializeWebcam() {
        const video = document.getElementById("user-cam");
        if (navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices
            .getUserMedia({
              video: { width: 1280, height: 720, facingMode: "user" },
            })
            .then((stream) => (video.srcObject = stream))
            .catch((err) => console.error("Webcam error", err));
        }
      }

      function startVoice() {
        if (isListening || isAIResponding || isSpeaking) {
          addMessageToChat(
            "System",
            "â›” Please wait until the interviewer completes the question.",
            "hr-message"
          );
          return;
        }
        accumulatedTranscript = "";
        startRecognition();
      }

      function startRestartTimer() {
        clearTimeout(restartTimer);
        restartTimer = setTimeout(() => {
          console.log("â±ï¸ Restarting voice input due to 45s limit");
          restartRecognition();
        }, RESTART_INTERVAL);
      }

      function startSilenceTimer() {
        clearTimeout(silenceTimer);
        silenceTimer = setTimeout(() => {
          if (accumulatedTranscript.trim()) {
            console.log("ðŸ• User silent for 5s, sending message");
            sendMessage();
          } else {
            addMessageToChat(
              "System",
              "ðŸ•’ No speech detected. Try again.",
              "hr-message"
            );
            stopRecognition();
          }
        }, SILENCE_TIMEOUT);
      }

      function startRecognition() {
        const SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
          alert("Speech Recognition not supported!");
          return;
        }

        recognition = new SpeechRecognition();
        recognition.lang = "en-IN";
        recognition.continuous = true;
        recognition.interimResults = true;

        // let hasSpokenPrompt = false;  // ðŸ‘ˆ Add this globally at the top

        recognition.onstart = () => {
          isListening = true;

          if (!hasSpokenPrompt) {
            addMessageToChat(
              "System",
              "ðŸŽ¤ Listening... Speak now.",
              "hr-message"
            );
            hasSpokenPrompt = true;
          }

          startRestartTimer();
          startSilenceTimer();
        };

        recognition.onresult = (e) => {
          let interim = "";
          for (let i = e.resultIndex; i < e.results.length; i++) {
            const transcript = e.results[i][0].transcript;
            if (e.results[i].isFinal) {
              accumulatedTranscript += transcript + " ";
            } else {
              interim += transcript;
            }
          }
          document.getElementById("user-input").value =
            accumulatedTranscript + interim;
          startSilenceTimer();
        };

        recognition.onerror = (e) => {
          console.error("Recognition error", e.error);
          addMessageToChat("System", "âŒ Error: " + e.error, "hr-message");
          stopRecognition();
        };

        recognition.onend = () => {
          if (isListening) {
            console.log("â›” Recognition ended unexpectedly. Restarting...");
            restartRecognition();
          }
        };

        try {
          recognition.start();
        } catch (e) {
          console.error("Start error", e);
        }
      }

      function restartRecognition() {
        if (recognition) {
          recognition.onend = null;
          recognition.stop();
        }
        startRecognition();
      }

      function stopRecognition() {
        clearTimeout(silenceTimer);
        clearTimeout(restartTimer);
        isListening = false;
        if (recognition) {
          recognition.onend = null;
          recognition.stop();
        }
      }

      function sendMessage() {
        // Clear any existing speech timers
        if (speechUnlockTimer) clearTimeout(speechUnlockTimer);
        if (speechTimeoutTimer) clearTimeout(speechTimeoutTimer);

        // Stop any ongoing speech synthesis when sending a new message
        if (window.speechSynthesis.speaking) {
          window.speechSynthesis.cancel();
          console.log("Cancelled ongoing speech synthesis for new message");
          addMessageToChat(
            "System",
            "ðŸ”‡ Previous voice-over stopped for new message.",
            "hr-message"
          );
        }

        // Reset all states
        isSpeaking = false;
        isAIResponding = false;
        document.getElementById("audio-animation").classList.remove("active");
        document.getElementById("unlock-btn").style.display = "none";

        stopRecognition();

        let input = document.getElementById("user-input");
        let message = input.value.trim() || accumulatedTranscript.trim();

        if (!message) return;

        input.value = "";
        accumulatedTranscript = "";

        addMessageToChat("You", message, "user-message");

        isAIResponding = true;

        fetch("/ask", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: `message=${encodeURIComponent(message)}`,
        })
          .then((res) => res.json())
          .then((data) => {
            if (!data.reply) throw new Error("No reply");

            const cleanReply = data.reply
              .replace(/(\([^)]*\))/g, "")
              .replace(/I'll wait for your message.*?(\.|\n)/gi, "")
              .replace(/No pressure.*?(\.|\n)/gi, "");

            addMessageToChat("Interviewer", cleanReply.trim(), "hr-message");

            // âš ï¸ If there's a response, speak it
            if (cleanReply.trim()) {
              speakMessage(cleanReply.trim());

              // Safety timeout in case speech events don't fire
              speechTimeoutTimer = setTimeout(() => {
                if (isSpeaking || isAIResponding) {
                  console.warn("Speech synthesis timeout - forcing unlock");
                  isSpeaking = false;
                  isAIResponding = false;
                  document.getElementById("user-input").disabled = false;
                  document
                    .getElementById("audio-animation")
                    .classList.remove("active");
                  document.getElementById("unlock-btn").style.display = "none";
                }
              }, 30000); // 30 second timeout
            } else {
              isAIResponding = false;
            }
          })
          .catch((err) => {
            console.error("Send error:", err);
            addMessageToChat(
              "System",
              "âš ï¸ Failed to send message.",
              "hr-message"
            );
          })
          .finally(() => {
            // âœ… Always unlock if not speaking
            if (!isSpeaking) isAIResponding = false;
          });
      }

      function speakMessage(text) {
        // Clear any existing timers
        if (speechUnlockTimer) clearTimeout(speechUnlockTimer);
        if (speechTimeoutTimer) clearTimeout(speechTimeoutTimer);

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = "en-IN";
        utterance.rate = 1.5;

        isSpeaking = true;
        isAIResponding = true; // Keep AI responding flag active during speech
        document.getElementById("user-input").disabled = false; // Allow typing during speech

        // Show unlock button after 5 seconds as a safety measure
        speechUnlockTimer = setTimeout(() => {
          if (isSpeaking || isAIResponding) {
            document.getElementById("unlock-btn").style.display =
              "inline-block";
          }
        }, 5000);

        // ðŸŒŸ Start HR animation
        document.getElementById("audio-animation").classList.add("active");

        utterance.onend = () => {
          if (speechUnlockTimer) clearTimeout(speechUnlockTimer);
          if (speechTimeoutTimer) clearTimeout(speechTimeoutTimer);
          isSpeaking = false;
          isAIResponding = false; // âœ… Unlock here
          document.getElementById("user-input").disabled = false;
          document.getElementById("audio-animation").classList.remove("active");
          document.getElementById("unlock-btn").style.display = "none";
        };

        utterance.onerror = () => {
          if (speechUnlockTimer) clearTimeout(speechUnlockTimer);
          if (speechTimeoutTimer) clearTimeout(speechTimeoutTimer);
          isSpeaking = false;
          isAIResponding = false; // âœ… Unlock on error too
          document.getElementById("user-input").disabled = false;
          document.getElementById("audio-animation").classList.remove("active");
          document.getElementById("unlock-btn").style.display = "none";
        };

        window.speechSynthesis.speak(utterance);
      }

      function forceUnlock() {
        console.log("Force unlocking interview interface");

        // Clear any speech-related timers
        if (speechUnlockTimer) clearTimeout(speechUnlockTimer);
        if (speechTimeoutTimer) clearTimeout(speechTimeoutTimer);

        // Stop any ongoing speech synthesis
        if (window.speechSynthesis.speaking) {
          window.speechSynthesis.cancel();
          console.log("Cancelled ongoing speech synthesis");
        }

        isSpeaking = false;
        isAIResponding = false;
        isListening = false;
        document.getElementById("user-input").disabled = false;
        document.getElementById("audio-animation").classList.remove("active");
        document.getElementById("unlock-btn").style.display = "none";
        addMessageToChat(
          "System",
          "ðŸ”“ Interface unlocked manually. Previous voice-over stopped.",
          "hr-message"
        );
      }

      function addMessageToChat(sender, text, className) {
        const container = document.getElementById("chat-container");
        const div = document.createElement("div");
        div.className = `message ${className}`;
        div.innerHTML = `<div class="message-header">${sender}</div><div>${text}</div>`;
        container.appendChild(div);

        // Scroll to the bottom smoothly
        container.scrollTo({
          top: container.scrollHeight,
          behavior: "smooth",
        });
      }
      function adjustChatHeight() {
        const chatContainer = document.getElementById("chat-container");
        const inputContainer = document.querySelector(".input-container");
        chatContainer.style.height =
          window.innerHeight - inputContainer.offsetHeight + "px";
      }

      // Call on load and resize (keyboard open/close)
      window.addEventListener("load", adjustChatHeight);
      window.addEventListener("resize", adjustChatHeight);

      async function endInterview() {
        window.speechSynthesis.cancel();
        stopRecognition();

        const btn = document.getElementById("end-interview-btn");
        const overlay = document.getElementById("loading-overlay");

        btn.disabled = true;
        btn.innerHTML =
          '<div class="loading-spinner"></div><span>Generating Report...</span>';
        overlay.classList.add("active");

        try {
          const res = await fetch("/generate-report", { method: "POST" });
          const data = await res.json();
          if (data.status === "success") {
            window.location.href = "/report";
          } else {
            throw new Error(data.message || "Unknown error");
          }
        } catch (err) {
          console.error("End error:", err);
          addMessageToChat(
            "System",
            "âŒ Failed to generate report.",
            "hr-message"
          );
        } finally {
          overlay.classList.remove("active");
          btn.disabled = false;
          btn.innerHTML = "End Interview";
        }
      }

      document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "hidden") {
          window.speechSynthesis.cancel();
          stopRecognition(); // prevent ghost restarts
        }
      });

      window.addEventListener("load", () => {
        if (recognition && recognition.stop) {
          window.speechSynthesis.cancel();
          stopRecognition(); // âœ… Stop any leftover recognition
        }
      });

      window.addEventListener("pageshow", (event) => {
        if (event.persisted && recognition && recognition.stop) {
          window.speechSynthesis.cancel();
          stopRecognition(); // âœ… Handles bfcache (back-forward cache)
        }
      });

      window.addEventListener("beforeunload", () => {
        if (recognition && recognition.stop) {
          window.speechSynthesis.cancel();
          stopRecognition(); // Prevents ghost sessions
        }
      });
      function addMessageToChat(sender, text, className) {
        const container = document.getElementById("chat-container");

        const div = document.createElement("div");
        div.className = `message ${className}`;
        div.innerHTML = `<div class="message-header">${sender}</div><div>${text}</div>`;
        container.appendChild(div);

        // Smooth scroll to bottom
        container.scrollTo({
          top: container.scrollHeight,
          behavior: "smooth", // scroll smoothly like WhatsApp
        });
      }
      function adjustChatForKeyboard() {
        const chatContainer = document.getElementById("chat-container");
        const inputContainer = document.querySelector(".input-container");

        // Available height: viewport height minus input container height
        const availableHeight =
          window.innerHeight - inputContainer.offsetHeight;
        chatContainer.style.height = availableHeight + "px";

        // Always scroll to bottom
        chatContainer.scrollTo({
          top: chatContainer.scrollHeight,
          behavior: "smooth",
        });
      }
      // When page loads
      window.addEventListener("load", adjustChatForKeyboard);

      // When window resizes (keyboard opens/closes)
      window.addEventListener("resize", adjustChatForKeyboard);

      // When a new message is added
      function addMessageToChat(sender, text, className) {
        const container = document.getElementById("chat-container");
        const div = document.createElement("div");
        div.className = `message ${className}`;
        div.innerHTML = `<div class="message-header">${sender}</div><div>${text}</div>`;

        // Check if user is near bottom before adding new message
        const isNearBottom =
          container.scrollHeight -
            container.scrollTop -
            container.clientHeight <
          50;

        container.appendChild(div);

        // Only auto-scroll if user was near bottom
        if (isNearBottom) {
          container.scrollTop = container.scrollHeight;
        }
      }
      function handleEndInterview() {
        document.getElementById("loading-overlay").classList.add("active");

        fetch("/end_interview", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
        })
          .then((res) => res.json())
          .then((data) => {
            document
              .getElementById("loading-overlay")
              .classList.remove("active");
            addMessageToChat(
              "System",
              " Interview Ended. Generating your report. Please check your email.",
              "hr-message"
            );
          })
          .catch((err) => {
            console.error("End interview fetch error:", err);
            document
              .getElementById("loading-overlay")
              .classList.remove("active");
            addMessageToChat(
              "System",
              " Error ending interview. Please try again.",
              "hr-message"
            );
          });
      }

      // âœ… Renamed toggle too
      function toggleMenu() {
        const menu = document.getElementById("hidden-menu");
        menu.classList.toggle("active");
      }

      // Close button handler
      document.addEventListener("DOMContentLoaded", () => {
        const closeBtn = document.getElementById("close-btn");
        const menu = document.getElementById("hidden-menu");

        if (closeBtn) {
          closeBtn.addEventListener("click", () => {
            menu.classList.remove("active");
          });
        }
      });
      
   let timerInterval = null;
let startTime = null;

function startTimer() {
  // Record start time
  startTime = Date.now();

  // Hide icon when timer starts
 

  // Start updating timer every second
  timerInterval = setInterval(updateTimer, 1000);
}

function updateTimer() {
  const timerText = document.getElementById("timer-text");
  const elapsedMs = Date.now() - startTime;
  const totalSeconds = Math.floor(elapsedMs / 1000);

  const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, "0");
  const seconds = String(totalSeconds % 60).padStart(2, "0");

  timerText.textContent = `${minutes}:${seconds}`;
}

// Start timer automatically when page loads
window.addEventListener("load", startTimer);


    </script>
  </body>
</html>
